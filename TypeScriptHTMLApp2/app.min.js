function getSector(n){for(var t=0;t<sectors.length;t++)if(sectors[t].pointIsIn(n))return sectors[t];return null}function loaded(){loadEntities(),crosshair=new GUI,crosshair.p=new vec2(512,384),crosshair.d=new vec2(70,48),crosshair.tex=getTex("LB_Crosshair.png"),guis.push(crosshair),entities.push(new Enemy(new vec2(690,250))),setInterval(update,17)}function update(){var t,n,i;for(gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.enable(gl.DEPTH_TEST),gl.uniformMatrix4fv(perspectivePT,!1,MakePerspective(90,4/3,1,1e3)),gl.uniformMatrix4fv(transformPT,!1,MakeTransform()),n=0;n<sectors.length;n++)sectors[n].draw();for(gl.uniform1f(MultPosition,1),gl.uniform4f(ColorPosition,0,0,0,0),n=0;n<entities.length;n++){if(entities[n].update(),entities[n].remove==!0){entities.splice(n,1),n--;continue}entities[n].s.pointIsIn(entities[n].p)||(t=getSector(entities[n].p),t!=null&&(entities[n].s=t)),entities[n].draw()}for(gl.disable(gl.DEPTH_TEST),gl.uniform1f(MultPosition,1),gl.uniform4f(ColorPosition,0,0,0,0),gl.uniformMatrix4fv(transformPT,!1,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),gl.uniformMatrix4fv(perspectivePT,!1,makeOrtho(0,1024,768,0,-1,1)),n=0;n<guis.length;n++)guis[n].draw();for(i in keypressed)keypressed[i]!=frame&&delete keypressed[i];frame=!frame}function quad(n,t,i,r,u){u.bind(),gl.bindBuffer(gl.ARRAY_BUFFER,vertBuffer),gl.vertexAttribPointer(VertexPositionTex,3,gl.FLOAT,!1,0,0),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([n.x,r,n.y,n.x,i,n.y,t.x,r,t.y,t.x,i,t.y]),gl.STREAM_DRAW),gl.bindBuffer(gl.ARRAY_BUFFER,uvBuffer),gl.vertexAttribPointer(VertexTexture,2,gl.FLOAT,!1,0,0),gl.drawArrays(gl.TRIANGLE_STRIP,0,4)}function line(n,t,i,r,u,f,e){gl.uniform1f(MultPosition,0),gl.uniform1f(TransPosition,0),gl.uniform4f(ColorPosition,u,f,e,1),gl.bindBuffer(gl.ARRAY_BUFFER,vertBuffer),gl.vertexAttribPointer(VertexPositionTex,3,gl.FLOAT,!1,0,0),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([n.x,r,n.y,t.x,i,t.y]),gl.STREAM_DRAW),gl.bindBuffer(gl.ARRAY_BUFFER,uvBuffer),gl.vertexAttribPointer(VertexTexture,2,gl.FLOAT,!1,0,0),gl.drawArrays(gl.LINES,0,2),gl.uniform1f(MultPosition,1),gl.uniform4f(ColorPosition,0,0,0,0)}function getTex(n){if(loadedTextures[n])return loadedTextures[n];alert(n+"is not loaded")}function initGL(){var n=document.getElementById("FragmentShader"),t=document.getElementById("VertexShader"),i,r;n&&t?(i=LoadShader(n),n=gl.createShader(gl.FRAGMENT_SHADER),gl.shaderSource(n,i),gl.compileShader(n),r=LoadShader(t),t=gl.createShader(gl.VERTEX_SHADER),gl.shaderSource(t,r),gl.compileShader(t),ShaderProgramTex=gl.createProgram(),gl.attachShader(ShaderProgramTex,n),gl.attachShader(ShaderProgramTex,t),gl.linkProgram(ShaderProgramTex),gl.useProgram(ShaderProgramTex),VertexPositionTex=gl.getAttribLocation(ShaderProgramTex,"VertexPosition"),gl.enableVertexAttribArray(VertexPositionTex),VertexTexture=gl.getAttribLocation(ShaderProgramTex,"TextureCoord"),gl.enableVertexAttribArray(VertexTexture),perspectivePT=gl.getUniformLocation(ShaderProgramTex,"PerspectiveMatrix"),transformPT=gl.getUniformLocation(ShaderProgramTex,"TransformationMatrix"),ColorPosition=gl.getUniformLocation(ShaderProgramTex,"color"),MultPosition=gl.getUniformLocation(ShaderProgramTex,"texMult"),ScalePosition=gl.getUniformLocation(ShaderProgramTex,"texScale"),TranPosition=gl.getUniformLocation(ShaderProgramTex,"texTran"),TransPosition=gl.getUniformLocation(ShaderProgramTex,"trans")):alert("Error, Could Not Find Shaders"),uvBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,uvBuffer),gl.vertexAttribPointer(VertexTexture,2,gl.FLOAT,!1,0,0),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,1,1,0]),gl.STATIC_DRAW),vertBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,vertBuffer),gl.vertexAttribPointer(VertexPositionTex,3,gl.FLOAT,!1,0,0),gl.clearColor(0,0,0,1),gl.enable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.enable(gl.BLEND)}function MakePerspective(n,t,i,r){var u=i*Math.tan(n*Math.PI/360),f=-(r+i)/(r-i),e=-2*r*i/(r-i),o=2*i/(u*t*2),s=2*i/(u*2);return[o,0,0,0,0,s,0,0,0,0,f,-1,0,0,e,0]}function MakeTransform(){var n=-player.angle*Math.PI/180,t=[Math.cos(n-Math.PI/2),0,Math.cos(n),0,0,1,0,0,Math.sin(n-Math.PI/2),0,Math.sin(n),0,player.p.x,player.z+player.height,player.p.y,1];return transpose(inverse(transpose(t)))}function LoadShader(n){for(var i="",t=n.firstChild;t;)t.nodeType==t.TEXT_NODE&&(i+=t.textContent),t=t.nextSibling;return i}function LoadTexture(n){var i;if(n.length==0){loaded();return}var r=n[1],u=n[2],t=new Image;t.onload=function(){var e=gl.createTexture(),f;gl.bindTexture(gl.TEXTURE_2D,e),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,t),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null),f=new Texture,f.id=e,f.name=i,f.w=t.width,f.h=t.height,f.s.x=r==0?1:r/f.w,f.s.y=u==0?1:u/f.h,loadedTextures[i]=f,LoadTexture(n)},t.onerror=function(){alert("error")},i=n[0],n.splice(0,3),t.src=i}function otherWallWithPoint(n,t,i,r){i||(i=walls),r||(r=!1);for(var u=0;u<i.length;u++)if(i[u]!=n&&(i[u].s==null||r)&&(i[u].a.dist(t)<.1||i[u].b.dist(t)<.1))return i[u];return null}function hexToRgb(n){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(n);return t?{r:parseInt(t[1],16)/256,g:parseInt(t[2],16)/256,b:parseInt(t[3],16)/256}:null}function isLeft(n,t,i){return(t.x-n.x)*(i.y-n.y)-(t.y-n.y)*(i.x-n.x)>0}function load(n){var l=["LB_Crosshair.png",35,24,"LB_Bow01.png",475,208,"LB_NPC03.png",128,128,"arrows.png",256,256,"LB_Target.png",44,44,"LB_Grass02.png",78,122,"LB_Grass01.png",91,128,"LB_Button01Off.png",11,11,"LB_Button01On.png",11,11],h,p,i,c,w,b,a,e,u,v,o,t,y,f,s,r;for(walls.splice(0,walls.length),sectors.splice(0,sectors.length),entities.splice(0,entities.length),guis.splice(0,guis.length),lpts=[],lines=n.split("\n"),h=parseInt(lines[0]),t=0;t<h;t++)u=new Wall,u.a=getVec2(lines[t*4+0+1]),u.b=getVec2(lines[t*4+1+1]),u.t=getVec2(lines[t*4+2+1]),u.textureName=lines[t*4+3+1].split(",")[1],l.indexOf(u.textureName)==-1&&(l.push(u.textureName),l.push(0),l.push(0)),walls.push(u);for(at=h*4+1,p=parseInt(lines[at]),at++,t=0;t<p;t++){for(i=new Sector,i.walls=[],h=parseInt(lines[at++]),r=0;r<h;r++)i.walls.push(walls[lines[at+r]]);for(at+=h,c=getVec2(lines[at++]),i.bottom=c.x,i.top=c.y,i.oBottom=i.bottom,i.oTop=i.top,c=lines[at++].split(","),i.floorColor=hexToRgb(c[0]),i.ceilingColor=hexToRgb(c[1]),w=parseInt(lines[at++]),i.pts=[],r=0;r<w;r++)i.pts.push(getVec2(lines[at++]));for(b=parseInt(lines[at++]),i.tris=[],r=0;r<b;r++)a=lines[at++].split(","),i.tris.push(makeTri(i.pts[a[0]],i.pts[a[1]],i.pts[a[2]]));i.p=getVec2(lines[at++]),sectors.push(i),i.extendedWalls=i.extendedWalls.concat(i.walls)}for(t=0;t<walls.length;t++)e=walls[t].t,walls[t].s=sectors[e.x],e.y!=-1&&(walls[t].portal=sectors[e.y],walls[t].isPortal=!0,walls[t].s.neighbors.indexOf(sectors[e.y])==-1&&(walls[t].s.neighbors.push(sectors[e.y]),walls[t].s.extendedWalls=walls[t].s.extendedWalls.concat(sectors[e.y].walls))),u=walls[t],v=u.b.minus(u.a),v.normalize(),o=new vec2(-v.y,v.x),f=u.a.plus(o),u.s.pointIsIn(f)||(o.x=-o.x,o.y=-o.y),u.n=o;for(t=0;t<sectors.length;t++){for(i.pts.splice(0,i.pts.length),y=i.walls[0],f=y.b,i.pts.push(f);;){if(s=otherWallWithPoint(y,f,i.walls,!0),s==null){alert("no closed loop!");break}if(s==i.walls[0])break;f=s.a.dist(f)<.1?s.b:s.a,i.pts.push(f),y=s}for(sectors[t].createBuffers(),r=0;r<sectors[t].tris.length;r++)sectors[t].tris[r].getNeighbors(sectors[t].tris)}LoadTexture(l)}function loadEntities(){for(var o=parseInt(lines[at++]),u,f=0;f<o;f++){for(var e=lines[at++],t=e.split(",")[1],s=parseInt(e.split(",")[0]);s>t.length;)t=t+"\n"+lines[at++];var i=getVec2(lines[at++]),n=t.split("\n"),r=n[0];if(r=="spawn"&&entities.push(new Player(i)),r=="g"&&addGrass(i),r=="btn"&&(u=sectors[parseInt(n[1])],entities.push(new Button(getClosestWall(i),function(){doDoor(u)}))),r=="trgt"){var u=sectors[parseInt(n[1])],h=parseFloat(n[2]),c=parseFloat(n[3]);entities.push(new Target(getClosestWall(i),h,function(){doDoor(u)},c))}}}function getVec2(n){for(var r=n.split(","),i=new vec2(parseFloat(r[0]),parseFloat(r[1])),t=0;t<lpts.length;t++)if(lpts[t].dist(i)<.1)return lpts[t];return lpts.push(i),i}function makeTri(n,t,i){var r=new Triangle;return r.points_=[],r.points_.push(n),r.points_.push(t),r.points_.push(i),r.center=n.plus(t.plus(i)).scale(.33333333333),r}function getClosestWall(n){for(var r=999999,u=null,i,t=0;t<walls.length;t++)i=distToSegmentSquared(n,walls[t].a,walls[t].b),i<r&&(r=i,u=walls[t]);return u}var gl,ShaderProgramTex,ShaderProgramColor,VertexPositionTex,VertexTexture,MultPosition,ColorPosition,ScalePosition,TranPosition,TransPosition,vertBuffer,uvBuffer,perspectivePT,transformPT,perspectivePC,transformPC,Wall=function(){function n(){this.s=null,this.textureName="",this.portal=null,this.isPortal=!1,this.left=null,this.right=null}return n}(),walls=[],Sector=function(){function n(){this.neighbors=[],this.extendedWalls=[]}return n.prototype.pointIsIn=function(n){return pointInPolygon(n,this.pts)},n.prototype.draw=function(){var i,n,t;for(gl.uniform1f(MultPosition,1),gl.uniform4f(ColorPosition,0,0,0,0),i=0;i<this.walls.length;i++)n=this.walls[i],n.isPortal?(t=n.portal,t.bottom>this.bottom&&quad(n.a,n.b,this.bottom,t.bottom,getTex(n.textureName)),t.top<this.top&&quad(n.a,n.b,t.top,this.top,getTex(n.textureName))):quad(n.a,n.b,this.bottom,this.top,getTex(n.textureName));gl.uniform1f(MultPosition,0),gl.uniform1f(TransPosition,this.bottom),gl.bindBuffer(gl.ARRAY_BUFFER,this.floorBuffer),gl.vertexAttribPointer(VertexPositionTex,3,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer),gl.vertexAttribPointer(VertexTexture,2,gl.FLOAT,!1,0,0),gl.uniform4f(ColorPosition,this.floorColor.r,this.floorColor.g,this.floorColor.b,1),gl.drawArrays(gl.TRIANGLES,0,this.tris.length*3),gl.uniform1f(TransPosition,this.top),gl.bindBuffer(gl.ARRAY_BUFFER,this.floorBuffer),gl.vertexAttribPointer(VertexPositionTex,3,gl.FLOAT,!1,0,0),gl.uniform4f(ColorPosition,this.ceilingColor.r,this.ceilingColor.g,this.ceilingColor.b,1),gl.drawArrays(gl.TRIANGLES,0,this.tris.length*3),gl.uniform1f(TransPosition,0)},n.prototype.createBuffers=function(){for(var n=[],r=[],i,t=0;t<this.tris.length;t++)for(n.push(this.tris[t].points_[0].x),n.push(0),n.push(this.tris[t].points_[0].y),n.push(this.tris[t].points_[1].x),n.push(0),n.push(this.tris[t].points_[1].y),n.push(this.tris[t].points_[2].x),n.push(0),n.push(this.tris[t].points_[2].y),i=0;i<6;i++)r.push(0);this.floorBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.floorBuffer),gl.vertexAttribPointer(VertexPositionTex,3,gl.FLOAT,!1,0,0),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(n),gl.STATIC_DRAW),this.uvBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer),gl.vertexAttribPointer(VertexTexture,2,gl.FLOAT,!1,0,0),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(r),gl.STATIC_DRAW)},n}(),sectors=[],GUI=function(){function n(){}return n.prototype.draw=function(){var n=new vec2(this.p.x-this.d.x/2,.9),t=new vec2(this.p.x+this.d.x/2,.9);quad(n,t,this.p.y-this.d.y/2,this.p.y+this.d.y/2,this.tex)},n}(),guis=[],crosshair,loadedTextures,Texture,lines,at,lpts;window.onload=function(){var n=document.getElementById("canvas");gl=document.getElementById("canvas").getContext("webgl"),gl||(gl=document.getElementById("canvas").getContext("experimental-webgl"),gl||alert("your browser does not support webgl")),initGL(),initInput(n),load(document.getElementById("frmFile").contentWindow.document.body.childNodes[0].innerHTML)},loadedTextures={},Texture=function(){function n(){this.s=new vec2(0,0)}return n.prototype.bind=function(){gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.id),gl.uniform1i(gl.getUniformLocation(ShaderProgramTex,"uSampler"),0),gl.uniform2f(ScalePosition,this.s.x,this.s.y)},n}()