var __extends=this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype,n.prototype=new r},Enemy=function(n){function t(t){n.call(this,t),this.height=5,this.route=null,this.aimFrame=0,this.lastSeen=null,this.angle=0,this.nSide=8,this.tex=getTex("LB_NPC03.png"),this.r=1.5,this.target=player,this.lastSeen=this.p,this.verticalTrans=.75}return __extends(t,n),t.prototype.update=function(){this.state?this.state():(this.canSeePlayer()==!0?(this.goto(player.p),document.getElementById("debug").innerHTML+="<br>saw player, goto"):this.p.dist(this.lastSeen)>10&&(this.goto(this.lastSeen),document.getElementById("debug").innerHTML+="<br>cant see player, going to last position"),this.aimFrame--),key.G&&(!this.route||this.route[this.route.length-1].dist(player.p)>50)&&(this.goto(player.p),document.getElementById("debug").innerHTML+="<br>force player left dest, redest"),n.prototype.update.call(this),this.z-this.s.bottom<-.3&&(this.z+=.3)},t.prototype.aim=function(){var n;if((this.p.dist(this.target.p)>80||this.canSeePlayer()==!1)&&this.aimFrame<-50&&(document.getElementById("debug").innerHTML+="<br>too far from target",this.goto(this.lastSeen)),this.aimFrame--,n=Math.atan2(this.target.p.y-this.p.y,this.target.p.x-this.p.x)*180/Math.PI,Math.abs(n-this.angle)<5?this.angle=n:n>this.angle?this.angle+=5:this.angle-=5,this.aimFrame<-100&&Math.abs(n-this.angle)<20){document.getElementById("debug").innerHTML+="<br>firing",this.aimFrame=200;var t=this.angle+Math.random()*1.5-.75,i=new Arrow(t,33,new vec2(Math.cos(this.angle*Math.PI/180-Math.PI/2)*2.5,Math.sin(this.angle*Math.PI/180-Math.PI/2)*2.5).plus(this.p),1,.7);entities.push(i)}},t.prototype.navigate=function(){var t,n,i;this.route.length>0&&this.canSeeFrom(this.route[this.route.length-1],this.p)==!0&&this.route[this.route.length-1].dist(player.p)>50&&(this.canSeePlayer()==!0?(this.goto(player.p),document.getElementById("debug").innerHTML+="<br>player left dest, redest"):this.p.dist(this.lastSeen)>5&&this.route[this.route.length-1].dist(this.lastSeen)>5&&(this.goto(this.lastSeen),document.getElementById("debug").innerHTML+="<br>player left dest, redest to last seen")),this.route.length==0||this.p.dist(this.route[this.route.length-1])<75&&this.canSeePlayer()==!0?(this.route=null,this.state=null,document.getElementById("debug").innerHTML+="<br>reached dest",this.p.dist(player.p)<77&&(this.state=this.aim,document.getElementById("debug").innerHTML+="<br>aim")):(t=copyvec2(this.p),n=this.route[0].minus(this.p),n.normalize(),n=this.p.dist(this.route[0])<.81?n.scale(this.p.dist(this.route[0])):n.scale(.8),this.angle=Math.atan2(n.y,n.x),t=t.plus(n),this.collideWithWalls(t),i=this.p.dist(this.route[0]),i<.1&&this.route.splice(0,1))},t.prototype.canSeeFrom=function(n,t){return getSector(n)==getSector(t)},t.prototype.canSeePlayer=function(){var n=player.s==this.s;return n==!0&&(this.lastSeen=copyvec2(player.p),document.getElementById("lastseen").innerHTML=""+this.lastSeen.x+", "+this.lastSeen.y),n},t.prototype.recursiveSearch=function(n,t){for(var r=n[n.length-1],u,f,i=0;i<r.neighbors.length;i++)if(n.indexOf(r.neighbors[i])==-1){if(u=n.slice(0),u.push(r.neighbors[i]),r.neighbors[i]==t)return u;if(f=this.recursiveSearch(u,t),f!=null)return f}return null},t.prototype.pathfindInSector=function(n,t,i,r,u,f){for(var s,h,c,e,o=0;o<r.walls.length;o++)if(r.walls[o]!=i&&(u==null||r.walls[o].portal!=u)&&lineLine(n,t,r.walls[o].a,r.walls[o].b)==!0)break;if(o==r.walls.length)f.push(t);else{for(s=null,h=null,e=0;e<r.tris.length;e++)if(r.tris[e].pointIsIn(n)&&(s=r.tris[e]),r.tris[e].pointIsIn(t)&&(h=r.tris[e]),s!=null&&h!=null)break;for(c=this.recursiveSearch([s],h),e=1;e<c.length-1;e++)f.push(c[e].center);f.push(t)}},t.prototype.goto=function(n){var r=[],f,e,o,i;if(n=copyvec2(n),f=getSector(n),this.state=this.navigate,this.s==f){this.pathfindInSector(this.p,n,null,f,null,r),this.route=r;return}if(e=this.recursiveSearch([this.s],f),e==null)alert("no path!");else{var c=null,h=this.p,l=null;for(o=0;o<e.length-1;o++){var t=e[o],u=null,s=null;for(i=0;i<t.walls.length;i++)if(t.walls[i].portal==e[o+1]){u=t.walls[i].a.plus(t.walls[i].b.minus(t.walls[i].a).scale(Math.random()*.6+.2)),s=t.walls[i];break}u==null?alert("boom!"):(u=u.plus(s.n.scale(this.r)),this.pathfindInSector(h,u,s,t,c,r)),c=t,h=u.minus(s.n.scale(this.r*3)),r.push(h),l=s}this.pathfindInSector(h,n,null,f,c,r),this.route=r}},t}(Entity3D)