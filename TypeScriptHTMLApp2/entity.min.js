function addGrass(n){var t=new BillboardEntity(n,getTex("LB_Grass0"+(Math.random()>=.5?"1":"2")+".png"));t.d=new vec2(2*.8,3*.8),t.z=t.s.bottom,entities.push(t)}function doDoor(n){n.top-n.bottom>.1?entities.push(new DoorDoer(n,!0)):entities.push(new DoorDoer(n,!1))}var __extends=this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype,n.prototype=new r},Entity=function(){function n(n){this.r=1,this.gravity=.3,this.remove=!1,this.z=0,this.p=n,this.s=getSector(this.p)}return n.prototype.update=function(){this.s&&this.z-this.s.bottom>this.gravity&&(this.z-=this.gravity)},n.prototype.draw=function(){},n.prototype.collideWithWalls=function(n){var u=new vec2(n.x-this.p.x,n.y-this.p.y),o=u.dist(new vec2(0,0)),i,t,r,f,e;if(o>1e-11){for(i=999999,r=0;r<this.s.extendedWalls.length;r++)f=distToSegmentSquared(n,this.s.extendedWalls[r].a,this.s.extendedWalls[r].b),f<i&&(i=f,t=this.s.extendedWalls[r]);return i<=this.r*this.r&&(t.isPortal==!0&&t.portal.bottom-this.z>2.1||t.isPortal==!1)?(i=Math.sqrt(i),u=new vec2(n.x-this.p.x,n.y-this.p.y),e=projectPoint(n,t.a,t.b),this.p=e.plus(t.n.scale(this.r)),!0):(this.p=n,!1)}},n}(),entities=[],Entity3D=function(n){function t(t){n.call(this,t),this.verticalTrans=0,this.d=new vec2(10,10),this.angle=0}return __extends(t,n),t.prototype.draw=function(){var t=this.p.minus(projectPoint(this.p,player.vpa,player.vpb)),i,r,n;t.normalize(),t=t.scale(this.d.x/2),i=new vec2(t.y,-t.x).plus(this.p),r=new vec2(-t.y,t.x).plus(this.p),t=this.p.minus(player.p),t.normalize(),n=Math.atan2(t.y,t.x),n-=this.angle*Math.PI/180,n+=Math.PI*2/this.nSide/2,n<0&&(n+=Math.PI*2),n>=Math.PI*2&&(n-=Math.PI*2),n/=Math.PI*2,n*=this.nSide,n=Math.floor(n),n/=this.nSide,gl.uniform2f(TranPosition,n,this.verticalTrans),quad(r,i,this.z,this.z+this.d.y,this.tex),gl.uniform2f(TranPosition,0,0)},t.prototype.update=function(){n.prototype.update.call(this)},t}(Entity),BillboardEntity=function(n){function t(t,i){n.call(this,t),this.d=new vec2(1,1),this.tex=i}return __extends(t,n),t.prototype.draw=function(){var n=this.p.minus(projectPoint(this.p,player.vpa,player.vpb)),t,i;n.normalize(),n=n.scale(this.d.x/2),t=new vec2(n.y,-n.x).plus(this.p),i=new vec2(-n.y,n.x).plus(this.p),quad(i,t,this.z,this.z+this.d.y,this.tex)},t}(Entity),Arrow=function(n){function t(t,i,r,u,f){var e,o;n.call(this,r),this.stuck=!1,this.angle=t,t=t*Math.PI/180,i=i*Math.PI/180,this.gravity=0,e=Math.cos(i),this.vz=Math.sin(i),o=0,this.v=new vec2(0,0),this.v.x=e*Math.cos(t)-o*Math.sin(t),this.v.y=e*Math.sin(t)+o*Math.cos(t),this.tex=getTex("arrows.png"),this.nSide=16,this.z=u,this.v.scale(f),this.vz*=.8}return __extends(t,n),t.prototype.update=function(){var t,i,n;if(this.stuck==!1&&(this.z+=this.vz,this.vz+=-.01,t=Math.abs(this.vz)/Math.sqrt(this.v.x*this.v.x+this.v.y*this.v.y+this.vz*this.vz),n=t>.99?0:t>.94?1:t>.2?2:3,this.vz<=0&&(n=6-n),n=7-n,this.verticalTrans=n*.125,i=this.p.plus(this.v),this.collideWithWalls(i)==!0&&(this.stuck=!0),this.z+this.d.y*.125+this.d.y*.875/2<this.s.bottom&&(this.z=this.s.bottom-this.d.y*.875/2,this.stuck=!0),this.z-this.d.y*.875/2>this.s.top&&(this.z=this.s.top+this.d.y*.875/2,this.stuck=!0),this.stuck==!0))for(n=0;n<entities.length;n++)entities[n].hit==!1&&this.p.dist(entities[n].p)<entities[n].r&&Math.abs(this.z+this.d.y/2-entities[n].z)<entities[n].r&&(entities[n].hit=!0,entities[n].func())},t}(Entity3D),Decal=function(n){function t(t,i,r,u,f){n.call(this,t.a.plus(t.b).scale(.5).plus(t.n.scale(.1))),this.z=i,this.r=r/2,this.height=u,this.tex=f,this.a=t.a.minus(this.p),this.a.normalize(),this.a=this.a.scale(this.r).plus(this.p),this.b=t.b.minus(this.p),this.b.normalize(),this.b=this.b.scale(this.r).plus(this.p),this.gravity=0}return __extends(t,n),t.prototype.draw=function(){quad(this.a,this.b,this.z-this.height/2,this.z+this.height/2,this.tex)},t}(Entity),Target=function(n){function t(t,i,r,u){typeof r=="undefined"&&(r=function(){}),typeof u=="undefined"&&(u=3.7),n.call(this,t,i,u*2,u*2,getTex("LB_Target.png")),this.hit=!1,this.func=r}return __extends(t,n),t}(Decal),Button=function(n){function t(t,i){n.call(this,t,5,3.5,3.5,getTex("LB_Button01Off.png")),this.onFor=0,this.func=i}return __extends(t,n),t.prototype.update=function(){if(this.onFor>0)this.onFor--,this.tex=this.onFor>0?getTex("LB_Button01On.png"):getTex("LB_Button01Off.png");else if(key.F){var n=Math.abs(Math.atan2(this.p.y-player.p.y,this.p.x-player.p.x))*180/Math.PI;Math.abs(n+player.angle)<40&&this.p.dist(player.p)<8&&(this.onFor=30,this.func())}},t}(Decal),DoorDoer=function(n){function t(t,i){n.call(this,new vec2(0,0)),this.s=t,this.dir=i}return __extends(t,n),t.prototype.update=function(){this.s!=player.s&&(this.dir==!0?(this.s.top-=.3,this.s.bottom>this.s.top&&(this.remove=!0,this.s.top=this.s.bottom)):(this.s.top+=.3,this.s.top>this.s.oTop&&(this.remove=!0,this.s.top=this.s.oTop)))},t}(Entity)